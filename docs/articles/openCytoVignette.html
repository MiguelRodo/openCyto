<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>An Introduction to the openCyto package • openCyto</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="An Introduction to the openCyto package">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">openCyto</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.21.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/HowToAutoGating.html">OpenCyto: How to use different auto gating functions</a>
    </li>
    <li>
      <a href="../articles/HowToWriteCSVTemplate.html">How to write a csv gating template</a>
    </li>
    <li>
      <a href="../articles/openCytoVignette.html">An Introduction to the openCyto package</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>An Introduction to the openCyto package</h1>
            
      
      
      <div class="hidden name"><code>openCytoVignette.Rmd</code></div>

    </div>

    
    
<pre><code>## Loading required package: flowWorkspaceData</code></pre>
<div id="an-introduction-to-opencyto-package" class="section level1">
<h1 class="hasAnchor">
<a href="#an-introduction-to-opencyto-package" class="anchor"></a>An Introduction to <strong>openCyto</strong> package</h1>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>1. Introduction</h2>
<p>The <strong>openCyto</strong> package is designed to facilitate the automated gating methods in sequential way to mimic the manual gating scheme.</p>
<div id="manual-gating" class="section level3">
<h3 class="hasAnchor">
<a href="#manual-gating" class="anchor"></a>1.1. Manual gating</h3>
<p>Traditionally, scientists have to draw the gates for each individual sample on each 2D projections (2 channels) within <code>flowJo</code>. Or draw the ’template gate’s on one sample and replicate it to other samples, then manually inspect the gate on each sample to do the correction if necessary. Either way is time consuming and subjective, thus not suitable for the large data sets generated by high-throughput flow Cytometers or the <code>cross-lab</code> data analysis.</p>
<p>Here is one <code>xml</code> workspace (manual gating scheme) exported from <code>flowJo</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">flowDataPath &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>, <span class="dt">package =</span> <span class="st">"flowWorkspaceData"</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">wsfile &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(flowDataPath, <span class="dt">pattern=</span><span class="st">"manual.xml"</span>,<span class="dt">full =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">wsfile</a></code></pre></div>
<pre><code>## [1] "/usr/local/lib/R/cytoset/flowWorkspaceData/extdata/manual.xml"</code></pre>
<p>By using<code>flowWorkspace</code>package, We can load it into R,</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(CytoML)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">ws &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/CytoML/man/open_flowjo_xml.html">open_flowjo_xml</a></span>(wsfile)</a></code></pre></div>
<p>apply (<code>flowjo_to_gatingset</code>) the<code>manual gates</code>defined in<code>xml</code>to the raw<code>FSC</code>files,</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">gs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/CytoML/man/flowjo_to_gatingset.html">flowjo_to_gatingset</a></span>(ws, <span class="dt">name=</span> <span class="st">"T-cell"</span>, <span class="dt">subset =</span><span class="dv">1</span>, <span class="dt">isNcdf =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>and then visualize the<code>Gating Hierarchy</code></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">gh &lt;-<span class="st"> </span>gs[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(gh)</a></code></pre></div>
<p><img src="openCytoVignette_files/figure-html/plot-manual-GatingHierarchy-1.png" width="700" style="display:block; margin: auto"> and the<code>gates</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggcyto)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/pkg/ggcyto/man/autoplot.html">autoplot</a></span>(gh)</a></code></pre></div>
<p><img src="openCytoVignette_files/figure-html/plot-manual-gates-1.png" width="864" style="display:block; margin: auto"> This is a gating scheme for <code>T cell</code> panel, which tries to identify <code>T cell</code> sub-populations. We can achieve the same results by using automated gating pipeline provided by this package.</p>
</div>
<div id="automated-gating" class="section level3">
<h3 class="hasAnchor">
<a href="#automated-gating" class="anchor"></a>1.2. Automated Gating</h3>
<p><code>flowCore</code>,<code>flowStats</code>,<code>flowClust</code> and other packages provides many different gating methods to detect cell populations and draw the gates automatically.</p>
<p><code>flowWorkspace</code> package provides the <code>GatingSet</code> as an efficient data structure to store, query and visualize the hierarchical gated data.</p>
<p>By taking advantage of these tools, <code>openCyto</code> package can create the automated gating pipeline by a <code>gating template</code>, which is essentially the same kind of hierarchical gating scheme used by the biologists and scientists.</p>
</div>
</div>
<div id="create-gating-templates" class="section level2">
<h2 class="hasAnchor">
<a href="#create-gating-templates" class="anchor"></a>2. Create gating templates</h2>
<div id="template-format" class="section level3">
<h3 class="hasAnchor">
<a href="#template-format" class="anchor"></a>2.1. Template format</h3>
<p>First of all, we need to describe the gating hierarchy in a spread sheet (a plain text format). This spread sheet must have the following columns: * <code>alias</code>: a name used label the cell population, the path composed by the alias and its precedent nodes (e.g. /root/A/B/alias) has to be uniquely identifiable. * <code>pop</code>: population patterns of <code>+/-</code> or <code>+/-+/-</code>, which tells the algorithm which side (postive or negative) of 1d gate or which quadrant of 2d gate to be kept. * <code>parent</code>: the parent population alias, its path has to be uniquely identifiable. * <code>dims</code>: characters seperated by comma specifying the dimensions(1d or 2d) used for gating. It can be either channel name or stained marker name. * <code>gating_method</code>: the name of the gating function (e.g. <code>flowClust</code>). It is invoked by a wrapper function that has the identical function name prefixed with a dot.(e.g. <code>.flowClust</code>) * <code>gating_args</code>: the named arguments passed to gating function * <code>collapseDataForGating</code>: When TRUE, data is collapsed (within groups if <code>groupBy</code> specified) before gating and the gate is replicated across collapsed samples. When set FALSE (or blank),then <code>groupBy</code> argument is only used by <code>preprocessing</code> and ignored by gating. * <code>groupBy</code>: If given, samples are split into groups by the unique combinations of study variable (i.e. column names of pData,e.g.“PTID:VISITNO”). when split is numeric, then samples are grouped by every N samples * <code>preprocessing_method</code>: the name of the preprocessing function(e.g. <code>prior_flowClust</code>). It is invoked by a wrapper function that has the identical function name prefixed with a dot.(e.g. <code>.prior_flowClust</code>) the preprocessing results are then passed to gating wrapper function through <code>pps_res</code> argument. * <code>preprocessing_args</code>: the named arguments passed to preprocessing function.</p>
</div>
<div id="example-template" class="section level3">
<h3 class="hasAnchor">
<a href="#example-template" class="anchor"></a>2.2. Example template</h3>
<p>Here is the an example of the gating template.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(openCyto)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(data.table)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">gtFile &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata/gating_template/tcell.csv"</span>, <span class="dt">package =</span> <span class="st">"openCyto"</span>)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">dtTemplate &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/fread.html">fread</a></span>(gtFile)</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">dtTemplate</a></code></pre></div>
<pre><code>##             alias    pop    parent        dims   gating_method
##  1:     nonDebris      +      root       FSC-A gate_mindensity
##  2:      singlets      + nonDebris FSC-A,FSC-H     singletGate
##  3:         lymph      +  singlets FSC-A,SSC-A       flowClust
##  4:           cd3      +     lymph         CD3 gate_mindensity
##  5:             * -/++/-       cd3     cd4,cd8 gate_mindensity
##  6: activated cd4     ++  cd4+cd8-    CD38,HLA        tailgate
##  7: activated cd8     ++  cd4-cd8+    CD38,HLA        tailgate
##  8:      CD45_neg      -  cd4+cd8-      CD45RA gate_mindensity
##  9:     CCR7_gate      +  CD45_neg        CCR7       flowClust
## 10:             * +/-+/-  cd4+cd8- CCR7,CD45RA         refGate
## 11:             * +/-+/-  cd4-cd8+ CCR7,CD45RA gate_mindensity
##               gating_args collapseDataForGating groupBy
##  1:                                          NA      NA
##  2:                                          NA      NA
##  3: K=2,target=c(1e5,5e4)                    NA      NA
##  4:                                        TRUE       4
##  5:     gate_range=c(1,3)                    NA      NA
##  6:                                          NA      NA
##  7:              tol=0.08                    NA      NA
##  8:     gate_range=c(2,3)                    NA      NA
##  9:           neg=1,pos=1                    NA      NA
## 10:    CD45_neg:CCR7_gate                    NA      NA
## 11:                                          NA      NA
##     preprocessing_method preprocessing_args
##  1:                                      NA
##  2:                                      NA
##  3:      prior_flowClust                 NA
##  4:                                      NA
##  5:                                      NA
##  6:  standardize_flowset                 NA
##  7:  standardize_flowset                 NA
##  8:                                      NA
##  9:                                      NA
## 10:                                      NA
## 11:                                      NA</code></pre>
<p>Each row is usually corresponding to one cell population and the gating method that is used to get that population. We will try to explain how to create this gating template based on the manual gating scheme row by row.</p>
<div id="nondebris" class="section level4">
<h4 class="hasAnchor">
<a href="#nondebris" class="anchor"></a>2.2.1. “nonDebris”</h4>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">dtTemplate[<span class="dv">1</span>,]</a></code></pre></div>
<pre><code>##        alias pop parent  dims   gating_method gating_args
## 1: nonDebris   +   root FSC-A gate_mindensity            
##    collapseDataForGating groupBy preprocessing_method preprocessing_args
## 1:                    NA      NA                                      NA</code></pre>
<ul>
<li>The population name is <code>"nonDebris"</code> (specified in <code>alias</code> field).</li>
<li>The <code>parent</code> node is <code>root</code> (which is always the first node of <code>gating hierarchy</code> by default).</li>
<li>We use <code>mindensity</code> (one of the <code>gating</code> functions provided by <code>openCyto</code> package) as <code>gating_method</code> to gate on dimension (<code>dim</code>) of <code>FSC-A</code>.</li>
<li>As the result, it will generate a 1d gate on <code>FSC-A</code>. <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code> in <code>pop</code> field indicates the <code>positive</code> side of 1d gate is kept as the population of interest.</li>
<li>There is no <code>grouping</code> or <code>preprocessing</code> involved in this gate, thus leave the other columns as <code>blank</code>
</li>
</ul>
</div>
<div id="singlets" class="section level4">
<h4 class="hasAnchor">
<a href="#singlets" class="anchor"></a>2.2.2. “singlets”</h4>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">dtTemplate[<span class="dv">2</span>,]</a></code></pre></div>
<pre><code>##       alias pop    parent        dims gating_method gating_args
## 1: singlets   + nonDebris FSC-A,FSC-H   singletGate            
##    collapseDataForGating groupBy preprocessing_method preprocessing_args
## 1:                    NA      NA                                      NA</code></pre>
<ul>
<li>The population name is <code>"singlets"</code> (<code>alias</code> field).</li>
<li>The <code>parent</code> node is <code>nonDebris</code>.</li>
<li>
<code>gating_method</code> is <code>singletGate</code> (function from by <code>flowStats</code> package)</li>
<li>As the result, a <code>polygonGate</code> will be generated on <code>FSC-A</code> and <code>FSC-H</code> (specified by <code>dims</code>) for each sample.</li>
<li>Again, <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code> in <code>pop</code> field stands for <code>"singlets+"</code>. But here it is 2d gate, which means we want to keep the area inside of the polygon</li>
</ul>
</div>
<div id="lymphocyte" class="section level4">
<h4 class="hasAnchor">
<a href="#lymphocyte" class="anchor"></a>2.2.3. “lymphocyte”</h4>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">dtTemplate[<span class="dv">3</span>,]</a></code></pre></div>
<pre><code>##    alias pop   parent        dims gating_method           gating_args
## 1: lymph   + singlets FSC-A,SSC-A     flowClust K=2,target=c(1e5,5e4)
##    collapseDataForGating groupBy preprocessing_method preprocessing_args
## 1:                    NA      NA      prior_flowClust                 NA</code></pre>
<ul>
<li>Similarly, <code>alias</code> specifies the name of population</li>
<li>
<code>parent</code> points to <code>singlets</code>
</li>
<li>Since we are going to use <code>flowClust</code> as <code>gating_method</code> to do the 2-dimensional gating, <code>dims</code> is comma separated string, <code>x</code> axis (<code>FSC-A</code>) goes first, <code>y</code> (<code>SSC-A</code>) the second. This order doesn’t affect the gating process but will determine how the gates are displayed.<br>
</li>
<li>All the parameters that <code>flowClust</code> algorithm accepts can be put in <code>gating-args</code> as if they are typed in <code>R console</code>. see <code><a href="https://rdrr.io/r/utils/help.html">help(flowClust)</a></code> for more details of these arguments</li>
<li>
<code>flowClust</code> algorithm accept the extra arguments <code>priors</code> that is calculated during <code>preprocessing</code> stage (before the actual <code>gating</code>), thus, we supply the <code>preprocessing_method</code> with <code>prior_flowClust</code>.</li>
</ul>
</div>
<div id="cd3-tcell" class="section level4">
<h4 class="hasAnchor">
<a href="#cd3-tcell" class="anchor"></a>2.2.4. “cd3+” (Tcell)</h4>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">dtTemplate[<span class="dv">4</span>,]</a></code></pre></div>
<pre><code>##    alias pop parent dims   gating_method gating_args collapseDataForGating
## 1:   cd3   +  lymph  CD3 gate_mindensity                              TRUE
##    groupBy preprocessing_method preprocessing_args
## 1:       4                                      NA</code></pre>
<p>It is similar to the <code>nonDebris</code> gate except that we specify <code>collapseDataForGating</code> as <code>TRUE</code>, which tells the pipeline to <code>collapse</code> all samples into one and applies <code>mindensity</code> to the collapsed data on <code>CD3</code> dimension. Once the gate is generated, it is replicated across all samples. This is only useful when each individual sample does not have enough events to deduce the gate. Here we do this just for the purpose of proof of concept.</p>
</div>
<div id="cd4-and-cd8" class="section level4">
<h4 class="hasAnchor">
<a href="#cd4-and-cd8" class="anchor"></a>2.2.5. CD4 and CD8</h4>
<p>The forth row specifies <code>pop</code> as <code>cd4+/-cd8+/-</code>, which will be expanded this into 6 rows.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">dtTemplate[<span class="dv">5</span>,]</a></code></pre></div>
<pre><code>##    alias    pop parent    dims   gating_method       gating_args
## 1:     * -/++/-    cd3 cd4,cd8 gate_mindensity gate_range=c(1,3)
##    collapseDataForGating groupBy preprocessing_method preprocessing_args
## 1:                    NA      NA                                      NA</code></pre>
<p>First two rows are two 1d gates that will be generated by <code>gating_method</code> on each dimension (<code>cd4</code> and <code>cd8</code>) independently:</p>
<pre><code>##    alias pop                        parent dims   gating_method
## 1:  cd4+   + /nonDebris/singlets/lymph/cd3  cd4 gate_mindensity
## 2:  cd8+   + /nonDebris/singlets/lymph/cd3  cd8 gate_mindensity
##          gating_args collapseDataForGating groupBy preprocessing_method
## 1: gate_range=c(1,3)                                                   
## 2: gate_range=c(1,3)                                                   
##    preprocessing_args
## 1:                   
## 2:</code></pre>
<p>Then another 4 rows are 4 <code>rectangleGate</code>s that corresponds to the 4 <code>quadrants</code> in 2d projection (<code>cd4 vs cd8</code>).</p>
<pre><code>##       alias pop                        parent    dims gating_method
## 1: cd4+cd8+  ++ /nonDebris/singlets/lymph/cd3 cd4,cd8       refGate
## 2: cd4-cd8+  -+ /nonDebris/singlets/lymph/cd3 cd4,cd8       refGate
## 3: cd4+cd8-  +- /nonDebris/singlets/lymph/cd3 cd4,cd8       refGate
## 4: cd4-cd8-  -- /nonDebris/singlets/lymph/cd3 cd4,cd8       refGate
##                                                              gating_args
## 1: /nonDebris/singlets/lymph/cd3/cd4+:/nonDebris/singlets/lymph/cd3/cd8+
## 2: /nonDebris/singlets/lymph/cd3/cd4+:/nonDebris/singlets/lymph/cd3/cd8+
## 3: /nonDebris/singlets/lymph/cd3/cd4+:/nonDebris/singlets/lymph/cd3/cd8+
## 4: /nonDebris/singlets/lymph/cd3/cd4+:/nonDebris/singlets/lymph/cd3/cd8+
##    collapseDataForGating groupBy preprocessing_method preprocessing_args
## 1:                                                                      
## 2:                                                                      
## 3:                                                                      
## 4:</code></pre>
<p>As we see here, <code>"refGate"</code> in <code>gating_method</code> indicates that they are constructed based on the <code>gate coordinates</code> of the previous two 1d gates. Those 1d gates are thus considered as <code>"reference gates"</code> that are referred by colon separated <code>alias</code> string in <code>gating_args</code>: <code>"cd4+:cd8+"</code>.</p>
<p>Alternatively, we can expand it into these 6 rows explicitly in the spread sheet. But this convenient representation is recommended unless user wants have finer control on how the gating is done. For instance, sometime we need to use different <code>gating_method</code>s to generate 1d gates on <code>cd4</code> and <code>cd8</code>. Or <code>cd8</code> gating needs to depend on <code>cd4</code> gating ,i.e. the <code>parent</code> of <code>c8+</code> is <code>cd4+</code>(or <code>cd4-</code>) instead of <code>cd3</code>. Sometimes we want to have the customized <code>alias</code> other than quadrant-like name (<code>x+y+</code>) that gets generated automatically. (e.g. 5th row of the gating template)</p>
</div>
</div>
</div>
<div id="load-gating-template" class="section level2">
<h2 class="hasAnchor">
<a href="#load-gating-template" class="anchor"></a>3. Load gating template</h2>
<p>After the gating template is defined in the spread sheet, it can be loaded into R:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">gt_tcell &lt;-<span class="st"> </span><span class="kw"><a href="../reference/gatingTemplate-class.html">gatingTemplate</a></span>(gtFile, <span class="dt">autostart =</span> 1L)</a>
<a class="sourceLine" id="cb22-2" data-line-number="2">gt_tcell</a></code></pre></div>
<pre><code>## --- Gating Template: default
##  with  29  populations defined</code></pre>
<p>Besides looking at the spread sheet, we can examine the gating scheme by visualizing it:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(gt_tcell)</a></code></pre></div>
<p><img src="openCytoVignette_files/figure-html/plot-gt-1.png" width="700" style="display:block; margin: auto"> As we can see, the gating scheme has been expanded as we described above. All the <strong>colored</strong> arrows source from the <code>parent</code> population and the <strong>grey</strong> arrows source from the <code>reference</code> population(/gate).</p>
</div>
<div id="run-the-gating-pipeline" class="section level2">
<h2 class="hasAnchor">
<a href="#run-the-gating-pipeline" class="anchor"></a>4. Run the gating pipeline</h2>
<p>Once we are satisfied with the gating template, we can apply it to the actual flow data.</p>
<div id="load-the-raw-data" class="section level3">
<h3 class="hasAnchor">
<a href="#load-the-raw-data" class="anchor"></a>4.1. Load the raw data</h3>
<p>First of all, we load the raw FCS files into R by <code><a href="https://rdrr.io/pkg/ncdfFlow/man/read.ncdfFlowSet.html">ncdfFlow::read.ncdfFlowSet</a></code> (It uses less memory than <code><a href="https://rdrr.io/pkg/flowCore/man/read.flowSet.html">flowCore::read.flowSet</a></code>) and create an empty <code>GatingSet</code> object.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">fcsFiles &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(<span class="dt">pattern =</span> <span class="st">"CytoTrol"</span>, flowDataPath, <span class="dt">full =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb25-2" data-line-number="2">ncfs  &lt;-<span class="st"> </span><span class="kw">read.ncdfFlowSet</span>(fcsFiles)</a>
<a class="sourceLine" id="cb25-3" data-line-number="3">fr &lt;-<span class="st"> </span>ncfs[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb25-4" data-line-number="4">gs &lt;-<span class="st"> </span><span class="kw">GatingSet</span>(ncfs)</a>
<a class="sourceLine" id="cb25-5" data-line-number="5">gs</a></code></pre></div>
<pre><code>## A GatingSet with 2 samples</code></pre>
</div>
<div id="compensation" class="section level3">
<h3 class="hasAnchor">
<a href="#compensation" class="anchor"></a>4.2. Compensation</h3>
<p>Then, compensate the data. If we have compensation controls (i.e. single stained samples), we can calculate the compensation matrix by <code>flowCore::spillover</code> function. Here we simply use the compensation matrix defined in <code>flowJo workspace</code>.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">compMat &lt;-<span class="st"> </span><span class="kw">gh_get_compensations</span>(gh)</a>
<a class="sourceLine" id="cb27-2" data-line-number="2">gs &lt;-<span class="st"> </span><span class="kw">compensate</span>(gs, compMat)</a></code></pre></div>
<p>Here is one example showing the compensation outcome: <img src="openCytoVignette_files/figure-html/compensate_plot-1.png" width="384" style="display:block; margin: auto"></p>
</div>
<div id="transformation" class="section level3">
<h3 class="hasAnchor">
<a href="#transformation" class="anchor"></a>4.3. Transformation</h3>
<p>All the stained channels need to be transformed properly before the gating. Here we use the <code><a href="https://rdrr.io/pkg/flowCore/man/logicleTransform.html">flowCore::estimateLogicle</a></code> to do the <code>logicle</code> transformation.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1">chnls &lt;-<span class="st"> </span><span class="kw">parameters</span>(compMat)</a>
<a class="sourceLine" id="cb28-2" data-line-number="2">trans &lt;-<span class="st"> </span><span class="kw">estimateLogicle</span>(gs[[<span class="dv">1</span>]], <span class="dt">channels =</span> chnls)</a>
<a class="sourceLine" id="cb28-3" data-line-number="3">gs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/transform.data.table.html">transform</a></span>(gs, trans)</a></code></pre></div>
<p>Here is one example showing the transformation outcome: <img src="openCytoVignette_files/figure-html/transformation_plot-1.png" width="480" style="display:block; margin: auto"></p>
</div>
<div id="gating" class="section level3">
<h3 class="hasAnchor">
<a href="#gating" class="anchor"></a>4.5. Gating</h3>
<p>Now we can apply the gating template to the data:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="kw"><a href="../reference/gt_gating.html">gating</a></span>(gt_tcell, gs)</a></code></pre></div>
<p>Optionally, we can run the pipeline in <code>parallel</code> to speed up gating. e.g.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="kw"><a href="../reference/gt_gating.html">gating</a></span>(gt_tcell, gs, <span class="dt">mc.cores=</span><span class="dv">2</span>, <span class="dt">parallel_type =</span> <span class="st">"multicore"</span>)</a></code></pre></div>
</div>
<div id="hide-nodes" class="section level3">
<h3 class="hasAnchor">
<a href="#hide-nodes" class="anchor"></a>4.6. Hide nodes</h3>
<p>After gating, there are some extra populations generated automatically by the pipeline (e.g. <code>refGate</code>).</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(gs[[<span class="dv">1</span>]])</a></code></pre></div>
<p><img src="openCytoVignette_files/figure-html/plot_afterGating-1.png" width="700" style="display:block; margin: auto"> We can hide these populations if we are not interested in them:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1">dodesToHide &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"cd8+"</span>, <span class="st">"cd4+"</span></a>
<a class="sourceLine" id="cb32-2" data-line-number="2">                , <span class="st">"cd4-cd8-"</span>, <span class="st">"cd4+cd8+"</span></a>
<a class="sourceLine" id="cb32-3" data-line-number="3">                , <span class="st">"cd4+cd8-/HLA+"</span>, <span class="st">"cd4+cd8-/CD38+"</span></a>
<a class="sourceLine" id="cb32-4" data-line-number="4">                , <span class="st">"cd4-cd8+/HLA+"</span>, <span class="st">"cd4-cd8+/CD38+"</span></a>
<a class="sourceLine" id="cb32-5" data-line-number="5">                , <span class="st">"CD45_neg/CCR7_gate"</span>, <span class="st">"cd4+cd8-/CD45_neg"</span></a>
<a class="sourceLine" id="cb32-6" data-line-number="6">                , <span class="st">"cd4-cd8+/CCR7+"</span>, <span class="st">"cd4-cd8+/CD45RA+"</span></a>
<a class="sourceLine" id="cb32-7" data-line-number="7">                )</a>
<a class="sourceLine" id="cb32-8" data-line-number="8"><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(dodesToHide, <span class="cf">function</span>(thisNode)<span class="kw">gs_pop_set_visibility</span>(gs, thisNode, <span class="ot">FALSE</span>))</a></code></pre></div>
</div>
<div id="rename-nodes" class="section level3">
<h3 class="hasAnchor">
<a href="#rename-nodes" class="anchor"></a>4.7. rename nodes</h3>
<p>And rename the populations:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="kw">gs_pop_set_name</span>(gs, <span class="st">"cd4+cd8-"</span>, <span class="st">"cd4"</span>)</a>
<a class="sourceLine" id="cb33-2" data-line-number="2"><span class="kw">gs_pop_set_name</span>(gs, <span class="st">"cd4-cd8+"</span>, <span class="st">"cd8"</span>)</a></code></pre></div>
</div>
<div id="visualization" class="section level3">
<h3 class="hasAnchor">
<a href="#visualization" class="anchor"></a>4.7. visualization</h3>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(gs[[<span class="dv">1</span>]])</a></code></pre></div>
<p><img src="openCytoVignette_files/figure-html/plot_afterHiding-1.png" width="700" style="display:block; margin: auto"></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/ggcyto/man/autoplot.html">autoplot</a></span>(gs[[<span class="dv">1</span>]])</a></code></pre></div>
<p><img src="openCytoVignette_files/figure-html/autoplot_autoGate-1.png" width="864" style="display:block; margin: auto"></p>
</div>
<div id="apply-a-gating-method-without-csv-template" class="section level3">
<h3 class="hasAnchor">
<a href="#apply-a-gating-method-without-csv-template" class="anchor"></a>4.8. Apply a gating method without csv template</h3>
<p>Sometime it will be helpful (especially to work with an already gated data) to be able to interact with he GatingSet directly without the need to write the compelete csv gating template.</p>
</div>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>5. Conclusion</h2>
<p>The <code>openCyto</code> package allows user to specify their gating schemes and gate the data in a data-driven fasion. It frees the scientists from the labor-intensitive manual gating routines and increases the speed as well as the reproducibilty and objectivity of the data analysis work.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#an-introduction-to-opencyto-package">An Introduction to <strong>openCyto</strong> package</a><ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">1. Introduction</a></li>
      <li><a href="#create-gating-templates">2. Create gating templates</a></li>
      <li><a href="#load-gating-template">3. Load gating template</a></li>
      <li><a href="#run-the-gating-pipeline">4. Run the gating pipeline</a></li>
      <li><a href="#conclusion">5. Conclusion</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mike Jiang.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
